<app-alerts></app-alerts>
<div class="flex-grow flex flex-col w-full max-h-screen min-w-screen min-h-screen lg:flex-row bg-base-100 p-0 m-0">
  <!-- Forum Threads Section -->
  <div *ngIf="!displayComments" class="flex flex-col w-full items-center bg-base-200 ">
    <div class="flex justify-between items-center p-4 h-1/8 w-full bg-white">
      <div class="flex justify-between items-center w-1/2">
        <button class="btn btn-secondary" (click)="openModal()">New Thread</button>
      </div>

      <div class="flex justify-between items-center w-1/2 gap-2">
        <input #searchInput
               type="text"
               placeholder="Search threads..."
               class="py-2 px-3 border border-gray-300 rounded-s shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm w-full mr-2 ml-2"
               (input)="filterThreads(searchInput.value)" />


        <button class="btn btn-primary" (click)="filterThreads(searchInput.value)">Search</button>
      </div>

    </div>

    <div class="flex-1 w-1/2 carousel carousel-vertical p-4 flex flex-col overflow-y-auto no-scrollbar bg-white text-base-content">
      <div *ngFor="let thread of forumThreads" class="card card-side w-full h-auto mb-4 btn bg-base-100 cursor-pointer" (click)="onRowClick(thread)">
        <div class="card-body w-full flex flex-row justify-between">
          <div class="ml-2">
            <h2 class="card-title">{{ thread.title }}</h2>
            <p class="text-sm">Posted by {{ thread.publisher }}</p>
            <p class="truncate">{{ thread.threadContent | slice:0:100 }}...</p>
          </div>

          <div class="mr-2 w-12 h-12 rounded-full bg-primary text-white flex items-center justify-center mr-4">
            <span class="text-2xl font-bold">{{ thread.comments?.length ?? 0 }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="displayComments" class="flex flex-col w-full">
    <div class="w-full h-1/8 bg-white p-4 flex flex-row justify-between">
      <div class="flex justify-between mb-4 px-4">
        <button class="btn btn-neutral" (click)="resetSelection()">Back to Forum</button>
      </div>

    </div>

    <div class="flex-1 overflow-y-auto px-4">
      <!-- Original Post -->
      <h1 class="text-2xl font-bold mb-4">{{ selectedThread?.title }}</h1>
      <div class="card bg-base-300 mb-4">
        <div class="card-body">
          <p><b>From:</b> {{ selectedThread?.publisher }}</p>
          <p>{{ selectedThread?.threadContent }}</p>
          <p><b>Time Sent:</b> {{ formatTimestamp(selectedThread?.timeSent) | date: 'medium' }} </p>
          <p *ngIf="selectedThread?.Edited"> <i>(Edited): </i> {{ formatTimestamp(selectedThread?.EditDate) | date: 'medium' }} </p>
        </div>
      </div>

      <button *ngIf="primaryUser.userDisplayName === selectedThread?.publisher" class="btn btn-secondary w-16" (click)="editThread()">Edit</button>

      <div class="divider divider-vertical divider-secondary"></div>

      <!-- Comments -->
      <h1 class="text-2xl font-bold mb-4">Comments</h1>
      <div *ngFor="let comment of selectedThreadComments">
        <div class="card bg-base-200 mb-4">
          <div class="card-body">
            <p><b>From:</b> {{ comment?.userId }}</p>
            <p>{{ comment?.messageContent }}</p>
            <p><b>Time Sent:</b> {{ formatTimestamp(comment?.timeSent) | date: 'medium' }}</p>
          </div>
        </div>
        <button *ngIf="primaryUser.userId == comment?.userId" class="btn btn-secondary" (click)="openEditCommentModal(comment)">Edit</button>
        <div class="divider divider-vertical divider-accent"></div>
      </div>

      <!-- Add a New Comment -->
      <form (submit)="addComment($event)" class="mt-4">
        <textarea class="textarea textarea-bordered w-full" placeholder="Type Comment Here" [(ngModel)]="newCommentContent" [ngModelOptions]="{standalone: true}"></textarea>
        <button class="btn btn-primary mt-4 mb-4" type="submit">Add Comment</button>
      </form>

    </div>
  </div>
</div>

<input type="checkbox" id="createThreadModal" class="modal-toggle" [checked]="isCreateThreaModalActive" />
<label for="createThreadModal" class="modal cursor-pointer" *ngIf="isCreateThreadModalActive">
  <label class="modal-box relative" for="">
    <h2 class="text-2xl font-bold text-center mb-4" id="modal-title">
      {{ selectedThread ? 'Edit Existing Thread' : 'Add New Thread' }}
    </h2>

    <form [formGroup]="newThreadForm" (ngSubmit)="addNewThread(); closeModal();" class="w-full">
      <!-- Title Input -->
      <div class="form-control w-full">
        <label for="title" class="label">
          <span class="label-text">Title</span>
        </label>
        <input type="text" id="title" formControlName="title" class="input input-bordered w-full" required />
      </div>
      <!-- Tags Input -->
      <div class="form-control w-full">
        <label for="tags" class="label">
          <span class="label-text">Tags</span>
        </label>
        <input type="text" id="tags" formControlName="tags" class="input input-bordered w-full" required />
      </div>
      <!-- Content Input -->
      <div class="form-control w-full">
        <label for="content" class="label">
          <span class="label-text">Content</span>
        </label>
        <textarea id="content" formControlName="content" class="textarea textarea-bordered w-full" required></textarea>
      </div>

      <div class="modal-action">
        <button class="btn btn-primary" type="submit" [disabled]="!newThreadForm.valid">Add Thread</button>
        <button class="btn btn-neutral" (click)="closeModal()">Cancel</button>
      </div>
    </form>
  </label>
</label>

<input type="checkbox" id="editCommentModal" class="modal-toggle" [checked]="isEditCommentModalActive" />
<label for="editCommentModal" class="modal cursor-pointer" *ngIf="isEditCommentModalActive">
  <label class="modal-box relative" for="">
    <h2 class="text-2xl font-bold text-center mb-4" id="modal-title">
      {{ selectedComment ? 'Edit Comment' : 'Add New Comment' }}
    </h2>

    <form [formGroup]="editCommentForm" (ngSubmit)="updateComment(); closeEditCommentModal();" class="w-full">
      <!-- Comment Content Input -->
      <div class="form-control w-full">
        <label for="commentContent" class="label">
          <span class="label-text">Comment</span>
        </label>
        <textarea id="commentContent" formControlName="content" class="textarea textarea-bordered w-full" required></textarea>
      </div>

      <div class="modal-action">
        <button class="btn btn-primary" type="submit" [disabled]="!editCommentForm.valid">Save Comment</button>
        <button class="btn btn-neutral" (click)="closeEditCommentModal()">Cancel</button>
      </div>
    </form>
  </label>
</label>
